databaseChangeLog:
  - changeSet:
      id: 003-create-tech-messages-table
      author: claude
      changes:
        - sql:
            dbms: postgresql
            sql: |
              CREATE TABLE tech_messages (
                id BIGSERIAL PRIMARY KEY,
                category VARCHAR(100) NOT NULL,
                severity VARCHAR(20) NOT NULL,
                pattern TEXT NOT NULL,
                description TEXT,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT chk_severity CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL'))
              );
            rollback: DROP TABLE IF EXISTS tech_messages CASCADE;

        - createIndex:
            indexName: idx_tech_messages_category
            tableName: tech_messages
            columns:
              - column:
                  name: category

        - createIndex:
            indexName: idx_tech_messages_severity
            tableName: tech_messages
            columns:
              - column:
                  name: severity

      rollback:
        - dropTable:
            tableName: tech_messages

  - changeSet:
      id: 003-create-action-levels-table
      author: claude
      changes:
        - sql:
            dbms: postgresql
            sql: |
              CREATE TABLE action_levels (
                id BIGSERIAL PRIMARY KEY,
                tech_message_id BIGINT NOT NULL,
                occurrence_min INT NOT NULL,
                occurrence_max INT,
                action_text TEXT NOT NULL,
                priority INT NOT NULL DEFAULT 1,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT fk_action_level_tech_message
                  FOREIGN KEY (tech_message_id)
                  REFERENCES tech_messages(id)
                  ON DELETE CASCADE
              );
            rollback: DROP TABLE IF EXISTS action_levels CASCADE;

        - createIndex:
            indexName: idx_action_levels_tech_message
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id

        - createIndex:
            indexName: idx_action_levels_priority
            tableName: action_levels
            columns:
              - column:
                  name: priority

      rollback:
        - dropTable:
            tableName: action_levels

  - changeSet:
      id: 003-insert-sample-tech-messages
      author: claude
      context: dev
      changes:
        - insert:
            tableName: tech_messages
            columns:
              - column:
                  name: category
                  value: "Network"
              - column:
                  name: severity
                  value: "HIGH"
              - column:
                  name: pattern
                  value: "Connection timeout to (?<host>[\\w.-]+):(?<port>\\d+)"
              - column:
                  name: description
                  value: "Network connection timeout - unable to reach remote host"

        - insert:
            tableName: tech_messages
            columns:
              - column:
                  name: category
                  value: "Database"
              - column:
                  name: severity
                  value: "CRITICAL"
              - column:
                  name: pattern
                  value: "Database connection pool exhausted.*remaining: (?<remaining>\\d+)"
              - column:
                  name: description
                  value: "Database connection pool is exhausted - all connections in use"

        - insert:
            tableName: tech_messages
            columns:
              - column:
                  name: category
                  value: "Application"
              - column:
                  name: severity
                  value: "MEDIUM"
              - column:
                  name: pattern
                  value: "OutOfMemoryError.*Java heap space"
              - column:
                  name: description
                  value: "Application ran out of memory - heap space exhausted"

        - insert:
            tableName: tech_messages
            columns:
              - column:
                  name: category
                  value: "Disk"
              - column:
                  name: severity
                  value: "CRITICAL"
              - column:
                  name: pattern
                  value: "No space left on device.*(?<partition>/[\\w/]+)"
              - column:
                  name: description
                  value: "Disk space exhausted on partition"

      rollback:
        - delete:
            tableName: tech_messages

  - changeSet:
      id: 003-insert-sample-action-levels
      author: claude
      context: dev
      changes:
        # Action levels for Network timeout (tech_message_id = 1)
        - insert:
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id
                  value: 1
              - column:
                  name: occurrence_min
                  value: 1
              - column:
                  name: occurrence_max
                  value: 3
              - column:
                  name: action_text
                  value: "1. Check network connectivity to the remote host\n2. Verify firewall rules\n3. Monitor for recurring issues"
              - column:
                  name: priority
                  value: 1

        - insert:
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id
                  value: 1
              - column:
                  name: occurrence_min
                  value: 4
              - column:
                  name: occurrence_max
                  value: 10
              - column:
                  name: action_text
                  value: "1. Escalate to network team - recurring connection issues\n2. Check for network path issues\n3. Review recent network changes\n4. Consider failover options"
              - column:
                  name: priority
                  value: 2

        - insert:
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id
                  value: 1
              - column:
                  name: occurrence_min
                  value: 11
              - column:
                  name: action_text
                  value: "CRITICAL: 1. Immediate escalation to network and infrastructure teams\n2. Activate incident response\n3. Consider switching to backup connection\n4. Alert management"
              - column:
                  name: priority
                  value: 3

        # Action levels for Database connection pool (tech_message_id = 2)
        - insert:
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id
                  value: 2
              - column:
                  name: occurrence_min
                  value: 1
              - column:
                  name: occurrence_max
                  value: 2
              - column:
                  name: action_text
                  value: "1. Check for long-running queries\n2. Review connection pool configuration\n3. Monitor database performance\n4. Kill idle connections if necessary"
              - column:
                  name: priority
                  value: 1

        - insert:
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id
                  value: 2
              - column:
                  name: occurrence_min
                  value: 3
              - column:
                  name: action_text
                  value: "URGENT: 1. Immediate DBA escalation\n2. Increase connection pool size\n3. Restart application if necessary\n4. Investigate connection leaks\n5. Alert on-call team"
              - column:
                  name: priority
                  value: 2

        # Action levels for OutOfMemoryError (tech_message_id = 3)
        - insert:
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id
                  value: 3
              - column:
                  name: occurrence_min
                  value: 1
              - column:
                  name: occurrence_max
                  value: 1
              - column:
                  name: action_text
                  value: "1. Restart application immediately\n2. Capture heap dump for analysis\n3. Review memory settings\n4. Check for memory leaks"
              - column:
                  name: priority
                  value: 1

        - insert:
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id
                  value: 3
              - column:
                  name: occurrence_min
                  value: 2
              - column:
                  name: action_text
                  value: "CRITICAL: 1. Escalate to development team\n2. Increase heap size\n3. Analyze heap dumps for memory leak\n4. Consider horizontal scaling\n5. Alert management"
              - column:
                  name: priority
                  value: 2

        # Action levels for Disk space (tech_message_id = 4)
        - insert:
            tableName: action_levels
            columns:
              - column:
                  name: tech_message_id
                  value: 4
              - column:
                  name: occurrence_min
                  value: 1
              - column:
                  name: action_text
                  value: "URGENT: 1. Free up disk space immediately\n2. Clear logs and temp files\n3. Identify large files consuming space\n4. Escalate to infrastructure team\n5. Consider disk expansion"
              - column:
                  name: priority
                  value: 1

      rollback:
        - delete:
            tableName: action_levels
